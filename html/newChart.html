<html>
    <head>

    </head>
    <body>
        <canvas id="graph" width="800" height="400" style="background-color: darkgrey" onmousemove="showTemp(event)" onmouseout="clearTemp()"></canvas>
        <p id="current"></p>
        <p id="selected"></p>
        <script>
                const X_MAX = 60;
                const Y_MAX = 50;
                const X_DIV = 5;
                const Y_DIV = 5;
    
                let canvas = document.getElementById('graph');
                let ctx = canvas.getContext('2d');
                let points = [];

                let counter = 0;

                setInterval(() => {
                    plotTemps();
                }, 1000);

                function plotTemps() {
                    var xhttp = new XMLHttpRequest();
                    xhttp.open("GET", "/getTemp", false);
                    xhttp.send();
                    document.getElementById('current').innerText = `Current: ${xhttp.responseText}°C`;
                    xhttp.open("GET", "/lastHour", false);
                    xhttp.send();
                    points = [];
                    JSON.parse(xhttp.responseText).forEach((e) => {
                        addPoint(e);
                    });
                }
    
                function addPoint(temp) {
                    if (points.length <= X_MAX) {
                        points.push(temp);
                    }
                    else {
                        for (let i = 0; i <= X_MAX - 1; i++) {
                            points[i] = points[i + 1];
                        }
                        points[X_MAX] = temp;
                    }
                    redraw();
                }

                function redraw() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    ctx.strokeStyle = "black";
                    ctx.fillStyle = "black";
                    ctx.font = "20px Courrier New";
                    ctx.textAlign="right";
                    for (let i = X_DIV; i < X_MAX; i += X_DIV) {
                        ctx.fillText(X_MAX - i , i * (canvas.width / X_MAX) - 2, canvas.height - 2);
                        ctx.beginPath();
                        ctx.moveTo(i * (canvas.width / X_MAX), 0);
                        ctx.lineTo(i * (canvas.width / X_MAX), canvas.height);
                        ctx.stroke();
                    }

                    for (let i = Y_DIV; i < Y_MAX; i += Y_DIV) {
                        ctx.fillText(Y_MAX - i , canvas.width - 1, i * (canvas.height / Y_MAX) - 2);
                        ctx.beginPath();
                        ctx.moveTo(0, i * (canvas.height / Y_MAX));
                        ctx.lineTo(canvas.width, i * (canvas.height / Y_MAX));
                        ctx.stroke();
                    }

                    ctx.strokeStyle = "blue";
                    for (let i = 0; i < points.length && points.length > 1; i++) {
                        ctx.beginPath();
                        ctx.moveTo(i * (canvas.width / X_MAX),  canvas.height - (points[i] * (canvas.height / Y_MAX)));
                        ctx.lineTo((i + 1) * (canvas.width / X_MAX), canvas.height - (points[i + 1] * (canvas.height / Y_MAX)));
                        ctx.stroke();
                    }
                }

                function showTemp(e) {
                    let x = e.offsetX;
                    let id = Math.round(x / (canvas.width / X_MAX));
                    redraw();
                    ctx.fillStyle = "red";
                    ctx.beginPath();
                    ctx.arc(id * (canvas.width / X_MAX),  canvas.height - (points[id] * (canvas.height / Y_MAX)),5,0,2*Math.PI);
                    ctx.fill();
                    document.getElementById('selected').innerText = `Selected: ${points[id]}°C (${60 - id} minutes ago)`;
                }

                function clearTemp() {
                    document.getElementById('selected').innerText = ``;
                }
            </script>
    </body>
</html>